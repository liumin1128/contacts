"use strict";var APP_ID="v6NXqif5dwd7iq47oyoCNVkU-gzGzoHsz",APP_KEY="qEXpBbxzJt4qNhX2U01olVPi";AV.init({appId:APP_ID,appKey:APP_KEY});var Contacts=AV.Object.extend("Contacts"),navView=Backbone.View.extend({el:$("body"),events:{"click button.searchBtn":"search","change input#keywords":"search","keyup input#keywords":"search","click a#order":"order","click a#edite":"edite"},initialize:function(){_.bindAll(this,"render","search","order"),this.render(),this.orderBy=0},search:function(e){$(".contactsList div").remove(),e.preventDefault();var n=$("#keywords").val(),a=new AV.Query("Contacts"),a=new AV.Query("Contacts");a.contains("name",n);var t=new AV.Query("Contacts");t.contains("phone",n);var i=AV.Query.or(a,t);i.find().then(function(e){for(var n=0;n<e.length;n++){var a=e[n].get("name"),t=e[n].get("phone"),i=e[n].id,o=e[n].createdAt;listView.creatOne(a,t,i,o)}},function(e){})},order:function(){this.orderBy=++this.orderBy%4,listView.order(this.orderBy)},edite:function(){$(".del").toggleClass("hid"),$(".pencil").toggleClass("hid")},render:function(){$(".container").append('<div class="row clearfix"><div class="col-md-12 column"><nav class="navbar navbar-default" role="navigation"><div class="navbar-header"><button class="navbar-toggle" type="button" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button> <a class="navbar-brand" href="#">Mini通讯录</a></div><div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1"><form class="navbar-form navbar-left" role="search"><div class="form-group"><input id="keywords" class="form-control" type="text" /></div> <button class="btn btn-default searchBtn"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button></form><ul class="nav navbar-nav navbar-right"><li><a class="btn" id="modal-741673" role="button" href="#modal-container-741673" data-toggle="modal"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></a></li><li><a class="btn" id="order" role="button"><span class="glyphicon glyphicon-sort" aria-hidden="true"></span></a></li><li><a class="btn" id="edite" role="button"><span class="glyphicon glyphicon-cog" aria-hidden="true"></span></a></li></ul></div></nav></div></div>')}}),navView=new navView;Backbone.sync=function(e,n,a,t){a()};var currentItem,Item=Backbone.Model.extend({defaults:{name:"",phone:"",_id:"",createdAt:""}}),List=Backbone.Collection.extend({model:Item}),ItemView=Backbone.View.extend({events:{"click span.change":"change","click span.del":"remove","click div.person":"show"},initialize:function(){_.bindAll(this,"render","unrender","change","remove","show"),this.model.bind("change",this.render),this.model.bind("remove",this.unrender)},show:function(){$(".del").addClass("hid"),$(".pencil").addClass("hid"),$(this.el).find(".del").toggleClass("hid"),$(this.el).find(".pencil").toggleClass("hid")},render:function(){return $(this.el).addClass("col-md-6"),$(this.el).html('<div class="person"><img class="img-responsive img-circle head"  src="images/headimg.jpg" alt=""><h3 class="name">'+this.model.get("name")+'</h3><p class="phone">'+this.model.get("phone")+'</p><span class="del hid delete"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></span><span class="pencil hid change"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></span></div>'),this},unrender:function(){var e=this,n=this.model.get("_id"),a=AV.Object.createWithoutData("Contacts",n);a.destroy().then(function(n){$(e.el).remove()},function(e){})},change:function(){$("#changeModal").modal("toggle"),currentItem=this},changed:function(){var e=this.model.get("_id"),n=this,a=$("#nameChanged").val(),t=$("#phoneChanged").val(),i=AV.Object.createWithoutData("Contacts",e);$("#nameChanged").val(""),$("#phoneChanged").val(""),i.set({name:a,phone:t}),i.save().then(function(e){var a={name:e.get("name"),phone:e.get("phone")};n.model.set(a)},function(e){console.log(e)})},remove:function(){this.model.destroy()}}),ListView=Backbone.View.extend({el:$("body"),events:{"click button#add":"addItem"},initialize:function(){_.bindAll(this,"render","addItem","appendItem"),this.collection=new List,this.collection.bind("add",this.appendItem),this.counter=0,this.getAll(),this.render()},getAll:function(){var e=this,n=new AV.Query("Contacts");n.find().then(function(n){for(var a=0;a<n.length;a++){var t=n[a].get("name"),i=n[a].get("phone"),o=n[a].id,s=n[a].createdAt;e.creatOne(t,i,o,s)}},function(e){})},order:function(e){$(".contactsList div").remove();var n=this,a=new AV.Query("Contacts");switch(e){case 0:a.ascending("createdAt");break;case 1:a.descending("createdAt");break;case 2:a.ascending("name");break;case 3:a.descending("name")}a.find().then(function(e){for(var a=0;a<e.length;a++){var t=e[a].get("name"),i=e[a].get("phone"),o=e[a].id,s=e[a].createdAt;n.creatOne(t,i,o,s)}},function(e){})},creatOne:function(e,n,a,t){var i=this,o=new Item;o.set({name:e,phone:n,_id:a,createdAt:t}),i.collection.add(o)},render:function(){var e=this;$(".container").append("<div class='contactsList row clearfix contacts'></div>"),_(this.collection.models).each(function(n){e.appendItem(n)},this)},addItem:function(){var e=this,n=$("#name").val(),a=$("#phone").val(),t=new Contacts;t.set("name",n),t.set("phone",a),t.set("priority",1),t.save().then(function(t){console.log("联系人:"+t.get("name")+"已储存!");var i=t.id,o=t.createdAt;e.creatOne(n,a,i,o)},function(e){console.log(e)})},appendItem:function(e){var n=new ItemView({model:e});$(".contactsList",this.el).append(n.render().el)}}),listView=new ListView,changeModalView=Backbone.View.extend({el:$("body"),events:{"click button#change":"change"},initialize:function(){_.bindAll(this,"render","change"),this.render()},change:function(){currentItem.changed()},render:function(){$(".container").append('<div class="row clearfix"><div class="col-md-12 column"><div class="modal fade" id="changeModal" role="dialog" aria-hidden="true" aria-labelledby="myModalLabel"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button><h4 class="modal-title" id="myModalLabel">修改联系人</h4></div><div class="modal-body"><div class="row clearfix"><div class="col-md-12 column"><form role="form" id="changeForm"><div class="form-group"><label for="name">用户名</label><input class="form-control" id="nameChanged" name="changeName" type="text" /></div><div class="form-group"><label for="phone">电话号码</label><input class="form-control" id="phoneChanged" name="changePhone" type="text" /></div></form></div><button class="btn btn-success btn-block" id="change" type="button" data-dismiss="modal">保存</button></div></div></div></div></div></div></div>')}}),changeModalView=new changeModalView,addModalView=Backbone.View.extend({el:$("body"),events:{"click button#add":"add"},initialize:function(){_.bindAll(this,"render","add"),this.render()},add:function(){listView.addItem()},render:function(){$(".container").append('<div class="row clearfix"><div class="col-md-12 column"><div class="modal fade" id="modal-container-741673" role="dialog" aria-hidden="true" aria-labelledby="myModalLabel"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><button class="close" aria-hidden="true" type="button" data-dismiss="modal">×</button><h4 class="modal-title" id="myModalLabel">新建联系人</h4></div><div class="modal-body"><div class="row clearfix"><div class="col-md-12 column"><form role="form" id="addForm"><div class="form-group"><label for="name">姓名</label><input class="form-control" id="name" name="name" type="text" /></div><div class="form-group"><label for="phone">电话号码</label><input class="form-control" id="phone" name="phone" type="text" /></div></form></div><button class="btn btn-success btn-block" id="add" type="button" data-dismiss="modal">保存</button></div></div></div></div></div></div></div>')}}),addModalView=new addModalView;$("#addForm").validate({errorElement:"span",errorClass:"help-block",focusInvalid:!1,rules:{name:{required:!0,minlength:2},phone:{required:!0,minlength:11}},messages:{name:{required:"请输入用户名",minlength:"用户名至少两个字符"},phone:{required:"请输入电话号码",minlength:"电话号码长度不能小于 11 个数字"}},highlight:function(e){$(e).closest(".form-group").addClass("has-error"),$(".btn-block").attr("disabled","disabled")},success:function(e){$(".btn-block").removeAttr("disabled"),e.closest(".form-group").removeClass("has-error"),e.remove()},errorPlacement:function(e,n){n.parent("div").append(e)}}),$("#changeForm").validate({errorElement:"span",errorClass:"help-block",focusInvalid:!1,rules:{changeName:{required:!0,minlength:2},changePhone:{required:!0,minlength:11}},messages:{changeName:{required:"请输入用户名",minlength:"用户名至少两个字符"},changePhone:{required:"请输入电话号码",minlength:"电话号码长度不能小于 11 个数字"}},highlight:function(e){$(e).closest(".form-group").addClass("has-error"),$(".btn-block").attr("disabled","disabled")},success:function(e){$(".btn-block").removeAttr("disabled"),e.closest(".form-group").removeClass("has-error"),e.remove()},errorPlacement:function(e,n){n.parent("div").append(e)}});